# Development

In oxbow, data I/O is handled in Rust with rich features exposed via Python and a limited exposure to R. It makes extensive use of the [`noodles`](https://github.com/zaeleus/noodles) and [`bigtools`](https://github.com/jackh726/bigtools) crates to parse genomic file formats.

The **oxbow** project a monorepo split into separate [Rust](https://github.com/abdenlab/oxbow/blob/main/py-oxbow), [Python](https://github.com/abdenlab/oxbow/blob/main/oxbow), and [R](https://github.com/abdenlab/oxbow/blob/main/r-oxbow) packages.

You can download sample data by [following these instructions](https://github.com/abdenlab/oxbow/blob/main/fixtures/README.md).


## Oxbow (Rust + Python)

### Project management

Ensure you have Rust installed on your system. You can install Rust using [`rustup`](https://rustup.rs/):

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

`py-oxbow` is a hybrid Rust-Python project and requires [`uv`](https://github.com/astral-sh/uv) for development, relying on [PyO3](https://pyo3.rs/)'s [`maturin`](https://github.com/PyO3/maturin) as a Python build system. Dependencies are organized into [PEP 735](https://peps.python.org/pep-0735/)-style _dependency groups_ in the `pyproject.toml`.

Install `uv` by following the instructions [here](https://docs.astral.sh/uv/getting-started/installation/). The following will create a virtual environment in `py-oxbow/.venv` with all dependency groups:

```sh
cd py-oxbow
uv sync
```

### Building the Rust crate only

The oxbow Rust crate alone can be built using the standard Rust package manager, [`cargo`](https://doc.rust-lang.org/stable/cargo/index.html). To build the library, navigate to the `oxbow` directory and run `cargo build`:

```bash
cd oxbow
cargo build  # --release (for non-debug build)
```

### Building the Rust-Python project

To (re)build and install a local development version of `oxbow` into your virtual environment:

```sh
cd py-oxbow
uvx maturin develop --uv
```

For a non-debug (and faster-running) build, add `--release`:

```sh
uvx maturin develop --uv --release
```

You can then test the build interactively:

```sh
uv run python
```

```python
>>> import oxbow as ox
>>> ...
```

or running one of the example notebooks:

```sh
uv run jupyter lab ./notebooks/bench.ipynb
```

### Linting and formatting

We use the standard Rust toolchain for linting and formatting Rust code.

[Clippy](https://doc.rust-lang.org/stable/clippy/index.html) is a Rust linter:
```bash
cargo clippy
```

The following command formats all source files of the current crate using `rustfmt`:
```bash
cargo fmt
```

We use [`ruff`](https://astral.sh/ruff) for linting and formatting Python code.

To validate the code style:
```sh
uv run ruff check
```

To format:
```sh
uv run ruff format
```

### Running Tests

To run tests on Rust code, we use `cargo`:

```bash
cargo test
```

For Python, we use [`pytest`](https://docs.pytest.org/):

```sh
uv run pytest
```

## R interface

To build the R bindings from source, navigate to the `r-oxbow` directory and start an interactive `R` environment.
Make sure you have the [`devtools`](https://devtools.r-lib.org/) and [`rextendr`](https://github.com/extendr/rextendr) libraries installed.

Changes must be recompiled as described [here](https://extendr.github.io/rextendr/articles/package.html#compile-and-use-the-package).

```R
library(devtools)
library(rextendr)
rextendr::document()
devtools::load_all(".")
```

The Rust extension code is found in `r-oxbow/src/rust/src/lib.rs`. You can use `cargo` commands for linting, formatting, and testing the Rust code. The automatically generated `R` wrappers are found in `r-oxbow/R/extendr-wrappers.rs`. Do not edit this file manually!

In order to provide default argument values, we layer on an additional wrapper on top of what `rextendr` generates in `r-oxbow/R/api.rs`. This is the user-facing API.

## Documentation

Documentation requires `py-oxbow`'s `uv` environment and uses the isolated `docs` dependency group.
It is managed with the [Sphinx](https://www.sphinx-doc.org/) documentation system and uses [MyST Markdown](https://mystmd.org/) and the [Sphinx Book theme](https://sphinx-book-theme.readthedocs.io/).

To build the docs once:
```sh
uv run --group=docs sphinx-build docs docs/_build/html
```

To run a live-reload server:

```sh
uv run --group=docs sphinx-autobuild docs docs/_build/html
```
